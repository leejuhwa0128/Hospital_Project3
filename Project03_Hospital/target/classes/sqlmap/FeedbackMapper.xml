<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hospital.mapper.FeedbackMapper">

	<insert id="insertFeedback"
		parameterType="com.hospital.vo.FeedbackVO">
		INSERT INTO feedbacks (
		feedback_id, patient_user_id,
		sender_name, phone, email, relation,
		patient_name, hospital_no,
		birth_date, category, title, content,
		status, writer_name, writer_pw,
		created_at
		)
		VALUES (
		seq_feedback_id.NEXTVAL, #{patientUserId},
		#{senderName}, #{phone},
		#{email}, #{relation}, #{patientName},
		#{hospitalNo}, #{birthDate},
		#{category}, #{title}, #{content}, '접수',
		#{writerName}, #{writerPw},
		SYSDATE
		)
	</insert>

	<select id="getFeedbackList" parameterType="map"
		resultType="com.hospital.vo.FeedbackVO">
		SELECT * FROM (
		SELECT ROWNUM AS rowNumber, A.*
		FROM (
		SELECT *
		FROM
		feedbacks
		WHERE 1=1
		<if test="category != null and category != ''">
			AND category = #{category}
		</if>
		<if test="status != null and status != ''">
			AND status = #{status}
		</if>
		ORDER BY feedback_id DESC
		) A
		WHERE ROWNUM &lt;= #{end}
		)
		WHERE rowNumber
		&gt;= #{start}
	</select>


	<select id="getTotalCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM feedbacks
		WHERE 1=1
		<if test="category != null and category != ''">
			AND category = #{category}
		</if>
		<if test="status != null and status != ''">
			AND status = #{status}
		</if>
	</select>



	<select id="getFeedback" resultType="com.hospital.vo.FeedbackVO"
		parameterType="int">
		SELECT
		feedback_id, patient_user_id, title, category,
		content,
		reply, replied_by, replied_at, status, created_at,
		writer_name, writer_pw
		FROM feedbacks
		WHERE feedback_id = #{feedbackId}
	</select>

	<update id="updateFeedback"
		parameterType="com.hospital.vo.FeedbackVO">
		UPDATE feedbacks
		SET title = #{title}, content =
		#{content}, category = #{category}
		WHERE feedback_id = #{feedbackId}
	</update>

	<delete id="deleteFeedback" parameterType="int">
		DELETE FROM feedbacks
		WHERE feedback_id = #{feedbackId}
	</delete>

	<update id="replyFeedback"
		parameterType="com.hospital.vo.FeedbackVO">
		UPDATE feedbacks
		SET reply = #{reply}, replied_by =
		#{repliedBy}, replied_at = SYSDATE,
		status = '답변완료'
		WHERE feedback_id =
		#{feedbackId}
	</update>
	<update id="clearReply" parameterType="int">
		UPDATE feedbacks
		SET reply
		= NULL, replied_by = NULL, replied_at = NULL, status = '접수'
		WHERE
		feedback_id = #{feedbackId}
	</update>
	<select id="selectAllFeedback"
		resultType="com.hospital.vo.FeedbackVO">
		SELECT
		feedback_id, patient_user_id, title, category,
		content,
		reply, replied_by, replied_at, status, created_at,
		writer_name, writer_pw
		FROM feedbacks
		ORDER BY feedback_id DESC
	</select>

	<select id="selectByUser"
		resultType="com.hospital.vo.FeedbackVO">
		SELECT * FROM feedbacks
		WHERE patient_user_id =
		#{patientUserId}
		ORDER BY created_at DESC
	</select>

	<select id="searchFeedbacksByKeyword" resultType="com.hospital.vo.FeedbackVO" parameterType="String">
	    SELECT
	    feedback_id, title, content, writer_name, category
	    FROM feedbacks
	    WHERE title LIKE '%' || #{keyword} || '%' OR content LIKE '%' || #{keyword} || '%'
	    ORDER BY feedback_id DESC
	</select>


</mapper>